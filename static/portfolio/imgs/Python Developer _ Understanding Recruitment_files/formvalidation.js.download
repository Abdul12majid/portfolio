var DATADOWNLOADFORMSESSION = "DownloadFormSession";

function validApteveForms(){
    $(document).on('click', '.apteveForm [type="submit"]', function(e){
        e.preventDefault();
        var isValid = true;
        var this_btn = $(this);

       
        var closestform = '#'+$(this).closest('form').attr('id');
        this_btn.hide();
        $('.element.submit', closestform).append('<button type="submit" class="btn spinnerbtn" disabled="disabled">\
                                                    <i class="fas fa-spinner fa-spin"></i>\
                                                </button>')

        var data_capture_download = "";
        var ccEmail = $('#media-hub-download-form').closest('.form-holder').find('[data-consultantemailcc]').attr('data-consultantemailcc');
        if($(closestform).closest('.form-holder').find('[data-download]').length > 0){
            data_capture_download = $(closestform).closest('.form-holder').find('[data-download]').attr('data-download');
        }

        if(data_capture_download != ""){
            sessionStorage.setItem(DATADOWNLOADFORMSESSION, data_capture_download)
        }

        if($("[name='ApteveDestinationEmails']", closestform).length > 0){
            $("[name='ApteveDestinationEmails']", closestform).val(ccEmail)
        }  
        

        if($('select[name="guideoptions"]', closestform).length > 0){
            if($('select[name="guideoptions"]', closestform).val() === ""){
                $('select[name="guideoptions"]', closestform).closest('.form-group').find('.required-text').show()
                isValid = false;
            } else{
                isValid = true;
            }
        }
       

        $('input[type=text]', closestform).each(function(){
            if($(this).is(':visible')){
                if($(this).attr('name') === "url"){
                    if($(this).val() === "" && $(this).attr('data-req') === "Required"){
                        $(this).closest('.form-group').find('.required-text').show()
                        $(this).closest('.form-group').find('.required-linkeidn').hide()
                        $(this).closest('.form-group').find('.required-dropbox').hide()
                        is_valid = false;
                    } else if($(this).val().indexOf("https://www.linkedin.com/") < 0){
                        $(this).closest('.form-group').find('.required-linkeidn').show()
                        is_valid = false;
                    } else if($(this).val().indexOf("https://www.dropbox.com/") < 0){
                        $(this).closest('.form-group').find('.required-linkeidn').show()
                        is_valid = false;
                    } else{
                        $(this).closest('.form-group').find('.required-text').hide()
                        $(this).closest('.form-group').find('.required-linkedin').hide()
                    }
                } else{
                    if($(this).val() === "" && $(this).attr('data-req') === "Required"){
                        $(this).closest('.form-group').find('.required-text').show()
                        is_valid = false;
                    } else{
                        $(this).closest('.form-group').find('.required-text').hide()
                    }
                }
            }
        })

        $('textarea', closestform).each(function(){
            if($(this).is(':visible')){
                if($(this).val() === "" && $(this).attr('data-req') === "Required"){
                    $(this).closest('.form-group').find('.required-text').show()
                    is_valid = false;
                } else{
                    $(this).closest('.form-group').find('.required-text').hide()
                }
            }
        })
                
        $('input[type=email]', closestform).each(function(){
            if($(this).is(':visible')){
                if($(this).val() === "" && $(this).attr('data-req') === "Required"){
                    $(this).closest('.form-group').find('.required-text').show();
                    $(this).closest('.form-group').find('.required-email').hide()
                } else if(isValidEmailAddress($(this).val()) === false){
                    $(this).closest('.form-group').find('.required-text').hide();
                    $(this).closest('.form-group').find('.required-email').show()
                    is_valid = false;
                } else{
                    $(this).closest('.form-group').find('.required-text').hide()
                    $(this).closest('.form-group').find('.required-email').hide()
                }
            }
        })
        
        $('input[type="checkbox"]', closestform).each(function(){
            if($(this).attr('data-req') === "Required" && $(this).prop('checked') === false){
                $(this).closest('.form-group').find('.required-text').show()
                is_valid = false;
            } else{
               $(this).closest('.form-group').find('.required-text').hide()
            }
        })
        
        $('select', closestform).each(function(){
            if($(this).attr('data-req') === "Required"){
                    if($(this).attr('data-isSelected') === 'false'){
                        $(this).closest('.form-group').find('.required-text').show()
                        is_valid = false;
                    } else{
                        $(this).closest('.form-group').find('.required-text').hide()
                    }
            }
        })

        $('input[type="file"]', closestform).each(function(){
            if($(this).is(':visible')){
                var error_displayed = $(this).closest('.element').find('.error').is(':visible');
                var error_displayed_class = $(this).closest('.element').find('.error:visible');
                if(error_displayed_class.length > 0){
                    error_displayed_class = error_displayed_class.attr('class').split(' ')[1];
                }
                if($(this).attr('data-req') === "Required"){
                    if($(this).attr('data-isFileValid') === "false" && error_displayed == false){
                        $(this).closest('.element').find('.required-text').show()
                    } else if($(this).attr('data-isFileValid') === "false" && error_displayed == true){
                        $(this).closest('.element').find('.error').each(function(){
                            if($(this).attr('class').indexOf(''+ error_displayed_class + '') >= 0){
                                $(this).show()
                            } else{
                                $(this).hide()
                            }
                        })
                    } else{
                        $(this).closest('.element').find('.error').each(function(){
                            $(this).hide()  
                        })
                    }
                }
            }
        })

        addUTMSessionValues(closestform);
        
        if($('.error:visible', closestform).length > 0 || isValid === false){
            $('.spinnerbtn').remove();
            this_btn.show();
            return false;
        } else{
            $(closestform).submit();
        } 
    }); 
}
validApteveForms();

function addUTMSessionValues(closestform){
    if(sessionStorage.getItem('UTMSOURCESESSION') !== null){
        $('input[name="utm_source"]', closestform).val(sessionStorage.getItem('UTMSOURCESESSION'));
    }

    if(sessionStorage.getItem('UTMCAMPAIGNSESSION') !== null){
        $('input[name="utm_campaign"]', closestform).val(sessionStorage.getItem('UTMCAMPAIGNSESSION'));
    }

    if(sessionStorage.getItem('UTMMEDIUMSESSION') !== null){
        $('input[name="utm_medium"]', closestform).val(sessionStorage.getItem('UTMMEDIUMSESSION'));
    }

    if(sessionStorage.getItem('UTMCONTENTSESSION') !== null){
        $('input[name="utm_content"]', closestform).val(sessionStorage.getItem('UTMCONTENTSESSION'));
    }

    if(sessionStorage.getItem('GOOGLECLICKIDSESSION') !== null){
        $('input[name="gclid"]', closestform).val(sessionStorage.getItem('GOOGLECLICKIDSESSION'));
    } 

    if(sessionStorage.getItem('ORIGINALUTMSOURCE') !== null){
        $('input[name="pagesource"]', closestform).val(sessionStorage.getItem('ORIGINALUTMSOURCE'));
    }

    if(sessionStorage.getItem('PAGESOURCESUBMISSION') !== null){
        $('input[name="submissionpagesource"]', closestform).val(sessionStorage.getItem('PAGESOURCESUBMISSION'));
    }
    
}

function isValidEmailAddress(emailAddress) {
    var pattern = new RegExp(/^[+a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,10}$/i);
    return pattern.test(emailAddress);
}


const isValidUrl = urlString=> {
  	var urlPattern = new RegExp('^(https?:\\/\\/)?'+ // validate protocol
	    '((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|'+ // validate domain name
	    '((\\d{1,3}\\.){3}\\d{1,3}))'+ // validate OR ip (v4) address
	    '(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*'+ // validate port and path
	    '(\\?[;&a-z\\d%_.~+=-]*)?'+ // validate query string
	    '(\\#[-a-z\\d_]*)?$','i'); // validate fragment locator
    return !!urlPattern.test(urlString);
}

function formFileUpload(){
    $('input[type="file"]').each(function(){
        $(this).change(function(e){
            var files = e.originalEvent.target.files;
            for (var i = 0, len = files.length; i < len; i++) {
                var file = files[i].name;
                if (file != null) {
                    var extension = file.substr((file.lastIndexOf('.') + 1));
                    switch (extension) {
                        case 'doc':
                        case 'pdf':
                        case 'docx':
                            flag = true;
                        break;
                            default:
                            flag = false;
                    }
                }
                else {
                    return false;
                }
                var id = e.originalEvent.target.id;
                if (flag == false) {
                    $(this).attr('data-isFileValid', "false");
                    if($(this).closest('.file').find('.required-filetype').length > 0){
                        $(this).closest('.file').find('.required-filesize').hide();
                            $(this).closest('.file').find('.required-text').hide();
                            $(this).closest('.file').find('.required-filetype').show();
                    } else{
                        $(this).closest('.file').find('.required-text').text('You can only upload doc, docx or pdf files').show();
                    }
                    return false;
                }
                else {
                    var size = GetFileSize(files[i]);
                    if (size > 10) {
                        $(this).attr('data-isFileValid', "false");
                        if($(this).closest('.file').find('.required-filesize').length > 0){
                            $(this).closest('.file').find('.required-filesize').show();
                            $(this).closest('.file').find('.required-text').hide();
                            $(this).closest('.file').find('.required-filetype').hide();
                        } else{                        
                            $(this).closest('.file').find('.required-text').text('You can only upload files up to 10 MB in size').show();
                        }
                        return false;
                    }
                    else {
                        $(this).closest('.file').find('.required-filesize').hide();
                        $(this).closest('.file').find('.required-text').hide();
                        $(this).closest('.file').find('.required-filetype').hide();
                        $(this).attr('data-isFileValid', "true");
                        return true;
                    }
                }
            }
        })
    })
}
formFileUpload();

function GetFileSize(file) {
    try {
        var fileSize = 0;
        fileSize = file.size //size in kb
        fileSize = fileSize / 1048576; //size in mb
        return fileSize;
    }
    catch (e) {
        alert("Error is :" + e);
    }
}

function selectChange(){
    $('.apteveForm select').each(function(){
        $(this).on('change', function(){
            var select_val = $(this).val();
            if(select_val === ""){
                $(this).attr('data-isSelected', "false");
            } else{
                $(this).attr('data-isSelected', "true");
            }
        })
    })
}
selectChange();

function downloadRedirect(){
    var url = window.location.pathname;
    var has_session_set = false;
    if(sessionStorage.DownloadFormSession === undefined || sessionStorage.DownloadFormSession === "undefined"){
        has_session_set = true;
    } else if(sessionStorage.DownloadFormSession === ''){
        has_session_set = true;
    }

    if(has_session_set === false){
        if(url.indexOf('thank-you') >= 0 || url.indexOf('thankyou') >= 0){
            let temp_url = sessionStorage.getItem(DATADOWNLOADFORMSESSION);
            sessionStorage.setItem(DATADOWNLOADFORMSESSION, '');            
            window.open(temp_url, '_self'); 
        }
    }
}
downloadRedirect();

function inputChangeApteveForms(){ 
    $('.apteveForm input[type="text"]').each(function(){ 
        $(this).on('input', function(){ 
            if($(this).val() === "" && $(this).attr('data-req') === "Required"){ 
                $(this).closest('.form-group').find('.required-text').show() 
            } else{ 
                $(this).closest('.form-group').find('.required-text').hide() 
            } 
        }) 
    }) 

    $('.apteveForm input[type="email"]').each(function(){ 
        $(this).on('input', function(){ 
            if($(this).val() === "" && $(this).attr('data-req') === "Required"){ 
                $(this).closest('.form-group').find('.required-text').show(); 
                $(this).closest('.form-group').find('.required-email').hide() 
            } else if(isValidEmailAddress($(this).val()) === false){ 
                $(this).closest('.form-group').find('.required-text').hide(); 
                $(this).closest('.form-group').find('.required-email').show() 
            } else{ 
                $(this).closest('.form-group').find('.required-text').hide() 
                $(this).closest('.form-group').find('.required-email').hide() 
            } 
        }) 
    }) 

    $('.apteveForm input[type="checkbox"]').each(function(){ 
        $(this).on('change', function(){ 
            if($(this).attr('data-req') === "Required" && $(this).prop('checked') === false){ 
                $(this).closest('.form-group').find('.required-text').show() 
            } else{ 
                $(this).closest('.form-group').find('.required-text').hide() 
            } 
        }) 
    }) 

    $('.apteveForm select').each(function(){ 
        $(this).on('change', function(){ 
            if($(this).attr('data-req') === "Required"){ 
                var select_val = $(this).val();
                if(select_val === ""){
                    $(this).attr('data-isSelected', "false");
                    $(this).closest('.form-group').find('.required-text').show()
                } else{
                    $(this).attr('data-isSelected', "true");
                    $(this).closest('.form-group').find('.required-text').hide()
                }
            } 
        }) 
    }) 

    $('.apteveForm textarea').each(function(){ 
        $(this).on('input', function(){ 
            if($(this).attr('data-req') === "Required" && $(this).val() === ""){ 
                $(this).closest('.form-group').find('.required-text').show() 
            } else{ 
                $(this).closest('.form-group').find('.required-text').hide() 
            } 
        }) 
    }) 
} 
inputChangeApteveForms();

$(document).ready(function(){
    if($('.legalterms').length > 0){
        $('form .legalterms').each(function(){
            var formLegalTermsCount = $('a', $(this)).length;
            var legaltermsloopCount = 0;
            $('a', $(this)).each(function(){
                legaltermsloopCount++;
                if(formLegalTermsCount === 2 && legaltermsloopCount < 2 || formLegalTermsCount === 3 && legaltermsloopCount === 2){
                    $(this).after(' & ')
                } else if(formLegalTermsCount === 3 && legaltermsloopCount === 1){
                    $(this).after(', ')
                } 
            })
        })
    }
})